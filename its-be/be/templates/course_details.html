{% extends 'base.html' %}

{% block title %}Course Details{% endblock %}

{% block content %}

<div class="content-wrapper">
  <h2>Course Details</h2>
  <ul class="course-info">
    <li id="course_id" data-value="{{ course.id }}">Course ID: {{ course.id }}</li>
    <li>Course Name: {{ course.name }}</li>
  </ul>

  {% if enrolled %}
  <p class="enrollment-status">Enrollment Status: Enrolled</p>
  <p>Selected Topics:</p>
  <form class="topic-form" action="/api/topics" method="post">
    {% for topic in topics %}
    <div class="topic">
      <input type="checkbox" name="{{topic.topic}}" value="{{topic.topic}}" checked>
      <label for="{{topic.topic}}">{{topic.topic}}</label>
    </div>
    {% endfor %}
    {% for avt in available_topics %}
    <div class="topic">
      <input type="checkbox" name="{{avt.topic}}" value="{{avt.topic}}">
      <label for="{{avt.topic}}">{{avt.topic}}</label>
    </div>
    {% endfor %}
    <input type="hidden" id="course" name="course" value="{{course.id}}" />
    <input class="update-button" type="submit" value="Update">
  </form>

  <button id="learn" class="learn-button">Learn</button>

  <div id="loading-icon" class="loading-container d-none">
    <div class="spinner-border text-primary" role="status"></div>
  </div>
  {% else %}
  <p class="enrollment-status">Enrollment Status: Not Enrolled</p>
  <button id="enroll-button" class="btn btn-primary mt-3 enroll-button">Enroll in Course</button>

  <p id="enrollment-status" class="enrollment-message"></p>
  <p href="#" id="refresh-link" class="refresh-link"></p>
  {% endif %}
</div>

{% if enrolled %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-6">
      <h3>Complete Tests</h3>
      <ul id="enrolled-courses" class="course-list">
        {% for test in tests_comp %}
        <li>
          <a href="/submit_test?test_id={{test.id}}" class="course-card card">
            <div class="card-body">
              <h5 class="card-text">ID: {{ test.id }} </h5>
            </div>
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-md-6">
      <h3>Incomplete Tests</h3>
      <ul id="available-courses" class="course-list">
        {% for test in tests_incomp %}
        <li>
          <a href="/incompTest?test_id={{test.id}}" class="course-card card">
            <div class="card-body">
              <h5 class="card-text">ID: {{ test.id }} </h5>
            </div>
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endif %}

<script>
const loadingIcon = document.getElementById('loading-icon');
document.addEventListener('DOMContentLoaded', function() {
const course_id = document.getElementById('course_id').getAttribute('data-value');
const refreshLink = document.getElementById('refresh-link');
  // Function to enroll the user in the course
  function enrollUserInCourse(course_id) {
    fetch('/api/course/enroll', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({
        course_id: course_id
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id.toString() === course_id) {
        document.getElementById('enrollment-status').textContent = 'Successfully Enrolled!';
        document.getElementById('enroll-button').disabled = true;
        window.location.reload(); 
      } else {
        document.getElementById('enrollment-status').textContent = 'Enrollment Failed. Please try again.';
      }
    })
    .catch(error => {
      console.error('Error enrolling in the course:', error);
      document.getElementById('enrollment-status').textContent = 'Enrollment Failed. Please try again.';
    });
  }
  const enrollButton = document.getElementById('enroll-button');
  if (enrollButton) {
    enrollButton.addEventListener('click', function() {
        console.log(course_id);
        enrollUserInCourse(course_id); // Pass the course ID to the enrollUserInCourse function
    });
  }
  // Add event listener for the Take Test button click
  const takeTestButton = document.getElementById('learn');
  if (takeTestButton) {
    takeTestButton.addEventListener('click', function() {
      loadingIcon.classList.remove('d-none');
        window.location.href = `/learning?course_id=${course_id}`; // Redirect to the "/userTest" page
    });
  }
});

</script>

<style>
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #f8f9fa;
  }

  .content-wrapper {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    margin: 20px auto;
    max-width: 800px;
  }

  .content-wrapper h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  .course-info {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .course-info li {
    margin-bottom: 10px;
  }

  .enrollment-status {
    font-weight: bold;
    color: #28a745;
  }

  .topic-form {
    margin-top: 20px;
  }

  .topic {
    margin-bottom: 10px;
  }

  .topic input {
    margin-right: 10px;
  }

  .update-button {
    background-color: #007bff;
    color: #ffffff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
  }

  .learn-button {
    background-color: #007bff;
    color: #ffffff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
  }

  .loading-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
  }

  .spinner-border {
    width: 2rem;
    height: 2rem;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
  }

  /* Custom styling for the course cards */
  .course-card {
    display: block;
    text-decoration: none;
    color: #333;
    transition: transform 0.2s ease;
  }

  .course-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .card {
    border: none;
    border-radius: 10px;
  }

  button-container {
  display: flex;
  align-items: center;
}

.enroll-button {
  display: inline-block;
  background-color: #007bff;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.2s ease;
}

.enroll-button:hover {
  background-color: #0056b3;
  transform: translateY(-3px);
}

</style>
{% endblock %}
